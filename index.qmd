---
title: "扩散先验在类超声阴影缺失逆问题中的应用"
author: "马忠慧 (学号：25113060024)"
date: last-modified
format:
  html:
    number-sections: true
    toc: true
    code-tools: true
    theme: cosmo
---

<style>
  /* 1. 全局段落缩进 2 字符，并设置两端对齐 */
  p {
    text-indent: 2em;
    text-align: justify;
  }

  /* 2. 排除不需要缩进的区域 */
  
  /* 提示框 (Callout) 内部通常不缩进，保持对齐更美观 */
  .callout p {
    text-indent: 0;
  }
  
  /* 列表项内部的段落不缩进 */
  li p {
    text-indent: 0;
  }

  /* 交互式图表 (Observable) 产生的文本不缩进，以免破坏 UI 布局 */
  .observablehq p {
    text-indent: 0;
  }
  
  /* 图片和表格的标题不缩进 */
  figure caption, .figure-caption {
    text-indent: 0;
  }
</style>

::: {.callout-note appearance="simple"}
**课程作业信息**

- **学号**：25113060024
- **姓名**：马忠慧
:::


## 引言

DDRM属于生成式模型（Generative Models）中的扩散模型（Diffusion Models）分支，解决面向逆问题的条件生成（conditional generation / inverse problem solving）。更具体地说，它处在“扩散模型 × 成像逆问题 × 物理先验约束”这一交叉区域：一方面，DDRM继承了扩散模型通过逐步去噪逼近真实数据分布的随机微分方程框架；另一方面，它通过对退化算子进行奇异值分解（SVD），在采样过程中显式约束各个频率分量的更新方式，使生成过程严格满足观测一致性（data consistency）。因此，DDRM不是在“学一个从退化图到清晰图的黑箱映射”，而是在用一个已经学好的数据分布先验，去“解”一个有物理结构的逆问题。在当前神经网络体系中，它代表了一条非常清晰的趋势：从端到端判别式学习，转向“生成式先验 + 物理模型驱动”的可解释、可推广成像框架。

## 从正问题到贝叶斯逆问题

在生物医学图像处理与成像领域中，我们通常将“物理世界到信号的映射”称为正问题，而将“由信号反推物理世界”的过程称为逆问题，将物理世界中真实但不可直接观测的结构记为 $x$，通过成像系统获得的测量信号或图像记为 $y$。二者之间的关系可以用一个最直观的箭头示意来描述：从 $x$ 指向 $y$ 的过程对应正问题，而从 $y$ 指回 $x$ 的过程对应逆问题：

$$
x \xrightarrow{\text{正问题}} y,\qquad
y \xrightarrow{\text{逆问题}} x
$$ 

然而，这两个方向并不对称。给定真实世界 $x$ 以及成像系统和物理规律，理论上可以确定性地计算出观测信号 $y$，这种过程我们表示为：

$$
y = Ax + n,
$$ 

其中 $A(\cdot)$ 表示正问题算子，例如模糊、遮挡、缺失或下采样等，$n$ 表示噪声项。若进一步假设噪声与信号无关，并服从独立同分布的高斯分布，则有：

$$
n \sim \mathcal{N}(0,\sigma^2 I),
$$

* **$n$ (随机向量)**: 这里 $n$ 是一个 $k$ 维列向量，向量的维数与信号空间的y一致。
* **$0$ (均值向量 $\mu$)**: 这里指的是零向量 $\mathbf{0} \in \mathbb{R}^k$。这意味着噪声是无偏的。
* **$\sigma^2 I$ (协方差矩阵 $\Sigma$)**: $\Sigma$ 是一个 $k \times k$ 的矩阵，描述了向量各分量之间的方差与相关性。

一个二维高斯噪声模型如图所示：
```{ojs}

// --- 居中版：绝对显示模式 ---

viewof n_center = Inputs.range([64, 512], { value: 256, step: 64, label: "分辨率 (n×n)" })
viewof sigma_center = Inputs.range([0.1, 5], { value: 1, step: 0.1, label: "噪声强度 σ (标准差)" })

md`当前分辨率: ${n_center}×${n_center}, 噪声强度: ${sigma_center.toFixed(1)}`

{
  const makeNoiseCanvas = (n, sigma) => {
    // --- 1. 参数定义 ---
    const mu = 0;          
    const seed = 1234;     
    const fixed_clip = 3;  
    
    // --- 2. 随机数生成逻辑 ---
    const prng = (s) => () => {
      s |= 0; s = (s + 0x6D2B79F5) | 0;
      let t = Math.imul(s ^ (s >>> 15), 1 | s);
      t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
    const rand = prng(seed);
    const randn = () => {
      let u = rand(); let v = rand();
      u = Math.max(u, 1e-12);
      return Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
    }

    // --- 3. 绘图逻辑 ---
    const c = document.createElement("canvas");
    c.width = n; c.height = n;
    const ctx = c.getContext("2d", { willReadFrequently: true });
    const img = ctx.createImageData(n, n);
    const data = img.data;
    const denom = fixed_clip * 1.0; 
    
    let i = 0;
    for (let p = 0; p < n * n; p++) {
      let val = mu + sigma * randn(); 
      let g = 128 + (val - mu) / denom * 128;
      g = Math.max(0, Math.min(255, Math.round(g)));
      data[i++] = g; data[i++] = g; data[i++] = g; data[i++] = 255; 
    }
    ctx.putImageData(img, 0, 0);
    
    // --- 4. 样式设置 ---
    c.style.width = "320px";
    c.style.height = "320px";
    c.style.border = "1px solid #ddd";
    c.style.imageRendering = "pixelated";
    
    // ============================
    // 【核心修改】添加居中容器
    // ============================
    const wrapper = document.createElement("div");
    wrapper.style.width = "100%";
    wrapper.style.display = "flex";
    wrapper.style.justifyContent = "center"; // 水平居中
    wrapper.style.alignItems = "center";
    wrapper.appendChild(c);

    // 返回容器，而不是直接返回 canvas
    return wrapper; 
  }

  return makeNoiseCanvas(n_center, sigma_center);
}

```
   
对于一般的多变量高斯分布 $X \sim \mathcal{N}(\mu, \Sigma)$，其概率密度函数定义为：
$$
f(\mathbf{x}) = \frac{1}{\sqrt{(2\pi)^k |\Sigma|}} \exp\left( -\frac{1}{2} (\mathbf{x} - \mu)^T \Sigma^{-1} (\mathbf{x} - \mu) \right)
$$
其中 $|\Sigma|$ 是协方差矩阵的行列式。针对我们特定的情况 $\mu = \mathbf{0}$ 和 $\Sigma = \sigma^2 I$，我们可以进行如下推导：
**行列式计算**:
   $$
   |\Sigma| = |\sigma^2 I| = (\sigma^2)^k |I| = (\sigma^{2})^k
   $$
**逆矩阵计算**:
   $$
   \Sigma^{-1} = (\sigma^2 I)^{-1} = \frac{1}{\sigma^2} I^{-1} = \frac{1}{\sigma^2} I
   $$
**协方差矩阵 $\Sigma = \sigma^2 I$ 的几何与代数意义**:

| 矩阵元素 | 数学定义 | 物理意义 | $\sigma^2 I$ 的情况 |
| :--- | :--- | :--- | :--- |
| **对角线元素** $\Sigma_{ii}$ | $Var(n_i) = \mathbb{E}[(n_i - \mu_i)^2]$ | 第 $i$ 个分量的方差（功率） | 所有分量方差均为 $\sigma^2$ (同分布) |
| **非对角线元素** $\Sigma_{ij} (i \neq j)$ | $Cov(n_i, n_j) = \mathbb{E}[(n_i - \mu_i)(n_j - \mu_j)]$ | 分量 $i$ 与 $j$ 的线性相关性 | 均为 0 (不相关/正态分布下即独立) |

协方差矩阵是实对称矩阵，根据谱定理，它一定可以正交对角化。对于 $\Sigma = \sigma^2 I$，所有特征值 $\lambda_1, \dots, \lambda_k$ 均等于 $\sigma^2$，任意一组正交基都可以作为特征向量。这导致了一个关键的几何性质——**旋转不变性**。这是 DDRM 算法能够在谱空间工作的基石。

**命题**: 若随机向量 $n \sim \mathcal{N}(0, \sigma^2 I)$，对于任意 $k \times k$ 的正交矩阵 $Q$（即 $Q^T Q = Q Q^T = I$），变换后的向量 $n' = Q n$ 依然服从分布 $\mathcal{N}(0, \sigma^2 I)$。

**证明**:

**线性变换性质**: 高斯变量的线性变换仍为高斯变量。

**均值变换**:
   $$
   \mathbb{E}[n'] = \mathbb{E}[Q n] = Q \mathbb{E}[n] = Q \cdot \mathbf{0} = \mathbf{0}
   $$

**协方差变换**:
   $$
   \begin{aligned}
   Cov(n') &= \mathbb{E}[(n' - \mathbf{0})(n' - \mathbf{0})^T] \\
           &= \mathbb{E}[(Qn)(Qn)^T] \\
           &= \mathbb{E}[Q n n^T Q^T] \\
           &= Q \mathbb{E}[n n^T] Q^T \\
           &= Q (\sigma^2 I) Q^T \\
           &= \sigma^2 (Q I Q^T) \\
           &= \sigma^2 (Q Q^T) \\
           &= \sigma^2 I
   \end{aligned}
   $$

旋转后的噪声 $n'$ 具有与原噪声完全相同的统计特性。这意味着我们可以在任意正交基（例如线性算子 $H$ 的 SVD 分解中的 $U$ 或 $V$ 矩阵）下分析白噪声，而无需担心改变其分布性质。

当我们求解逆问题时，仅凭有限、退化且不可避免地受到噪声污染的观测 $y$，往往存在多个不同的 $x$ 都可以生成同一个 $y$。换言之，正问题通常是确定性的，而逆问题在本质上是不确定的。这种不对称性正是成像逆问题困难性的根源。基于这种不对称性，我们更倾向于用概率语言来表达逆问题中“相信程度”的更新。由于同一个观测 $y$ 可能对应多个可能的物理世界 $x$，逆问题的目标便不再适合被表述为“寻找唯一正确的解”。更合理的提法是：在当前可获得的信息条件下，我对不同候选 $x$ 的相信程度分别有多大？基于此，概率模型被引入，逆问题转变为后验分布 $p(x\mid y)$，即在观测到信号 $y$ 之后，对真实世界 $x$ 的相信程度。贝叶斯公式为这一思想提供了严格而统一的数学表达：


$$
p(x | y) = \frac{p(y | x) p(x)}{p(y)}
$$


 先验概率  $p(x)$ 概括了在观测到任何数据之前，我们对未知信号 $x$ 的所有知识与信念。在图像恢复中， $p(x)$ 代表了“自然图像流形”（。它定义了什么样的像素排列构成一张合理的自然图像（如边缘的连续性、纹理的统计规律等），并赋予高概率；而对于随机噪声图像，赋予极低的概率。 扩散模型（Diffusion Models）本质上就是一种学习到的先验。通过训练，扩散模型隐式地学习了 $\nabla_x \log p(x)$。DDRM 利用这个预训练的强先验来指导恢复过程，确保恢复结果不仅符合观测数据，还具备自然图像的特征。由于 $n = y - Ax$，且 $n$ 服从高斯分布，我们可以直接写出似然函数的解析式：

$$
p(y | x) \propto \exp\left( -\frac{\|y - Ax\|^2}{2\sigma_y^2} \right)
$$

 后验分布是贝叶斯推断的终极目标，它融合了先验知识与观测数据，给出了给定观测 $y$ 下 $x$ 的概率分布。

$$
p(x | y) \propto \exp\left( -\frac{\|y - Ax\|^2}{2\sigma_y^2} \right) p(x)
$$

或在对数域中（忽略常数项）：

$$
\log p(x | y) = \log p(x) - \frac{1}{2\sigma_y^2} \|y - Ax\|^2 + C
$$

* 第一项 $\log p(x)$ 推动解向自然图像流形靠拢（正则化）。
* 第二项 $-\frac{1}{2\sigma_y^2} \|y - Ax\|^2$ 推动解符合观测数据（保真度）。
* 系数 $\frac{1}{2\sigma_y^2}$ 起到了拉格朗日乘子的作用，平衡这两股力量。


## 谱空间变换

DDRM 区别于其他基于扩散的逆问题求解器的关键在于其**谱空间处理**。这种处理方式源于对观测方程 $\mathbf{y} = \mathbf{A}\mathbf{x} + \mathbf{z}$ 的深入代数分析。对于任意实矩阵 $\mathbf{A} \in \mathbb{R}^{m \times n}$，存在奇异值分解：

$$
\mathbf{A} = \mathbf{U} \mathbf{\Sigma} \mathbf{V}^\top
$$ {#eq-svd}

其中：

* $\mathbf{U} \in \mathbb{R}^{m \times m}$ 是正交矩阵，满足 $\mathbf{U}^\top \mathbf{U} = \mathbf{I}_m$。
* $\mathbf{V} \in \mathbb{R}^{n \times n}$ 是正交矩阵，满足 $\mathbf{V}^\top \mathbf{V} = \mathbf{I}_n$。
* $\mathbf{\Sigma} \in \mathbb{R}^{m \times n}$ 是矩形对角矩阵，其对角线元素 $s_i = \mathbf{\Sigma}_{ii} \ge 0$ 为奇异值。

定义 **谱空间 (Spectral Space)** 中的变量为原空间变量在奇异向量基下的投影。定义变换后的变量：

$$
\begin{aligned}
\bar{\mathbf{x}} &= \mathbf{V}^\top \mathbf{x} \in \mathbb{R}^n \\
\bar{\mathbf{y}} &= \mathbf{U}^\top \mathbf{y} \in \mathbb{R}^m \\
\bar{\mathbf{z}} &= \mathbf{U}^\top \mathbf{z} \in \mathbb{R}^m
\end{aligned}
$$ {#eq-spectral-vars}

由于 $\mathbf{U}$ 是正交矩阵，线性变换 $\bar{\mathbf{z}} = \mathbf{U}^\top \mathbf{z}$ 保持了高斯噪声的统计特性（旋转不变性），即 $\bar{\mathbf{z}} \sim \mathcal{N}(\mathbf{0}, \sigma_y^2 \mathbf{I})$。

将 SVD 公式代入观测方程 $\mathbf{y} = \mathbf{U}\mathbf{\Sigma}\mathbf{V}^\top \mathbf{x} + \mathbf{z}$ 并左乘 $\mathbf{U}^\top$，我们得到：

$$
\mathbf{U}^\top \mathbf{y} = \mathbf{U}^\top \mathbf{U} \mathbf{\Sigma} \mathbf{V}^\top \mathbf{x} + \mathbf{U}^\top \mathbf{z} \implies \bar{\mathbf{y}} = \mathbf{\Sigma} \bar{\mathbf{x}} + \bar{\mathbf{z}}
$$

这一步至关重要。由于 $\mathbf{\Sigma}$ 是对角矩阵，上述向量方程实际上等价于 $m$ 个相互独立的标量方程。对于第 $i$ 个分量 ($i = 1, \dots, m$)：

$$
\bar{y}_i = s_i \bar{x}_i + \bar{z}_i
$$ {#eq-scalar-decoupling}

这表明，在谱空间中，复杂的逆问题被解耦为 $n$ 个独立的一维问题（对于 $i > m$ 的分量，没有观测值，等价于 $s_i = 0$）,这样就实现了解耦，使得DDRM 在反向扩散的每一步同时施加先验去噪与逐维数据一致性修正，使生成过程稳定地向满足观测的后验解收敛。根据奇异值 $s_i$ 的大小，谱空间中的每个模态 (Eigenmode) 可以分为两类。你可以通过下方的交互图来体会 $s_i$ 对观测信息的影响。

**零空间/缺失模态 ($s_i = 0$)**：
    此时方程变为 $\bar{y}_i = \bar{z}_i$（如果 $i \le m$）或无方程（如果 $i > m$）。这意味着观测数据 $\mathbf{y}$ 不包含任何关于 $\bar{x}_i$ 的信息。恢复 $\bar{x}_i$ 完全依赖于先验知识（扩散模型）。这对应于图像修复中的缺失区域或超分辨率中丢失的高频分量。

 **观测模态 ($s_i > 0$)**：
    此时 $\bar{y}_i$ 提供了关于 $\bar{x}_i$ 的有噪测量：$\bar{y}_i \sim \mathcal{N}(s_i \bar{x}_i, \sigma_y^2)$。我们可以从中提取出关于 $\bar{x}_i$ 的似然信息。然而，不同 $s_i$ 对应的信噪比不同。当 $s_i$ 很小时，观测值中的信号极其微弱，噪声占主导；当 $s_i$ 很大时，观测值非常可靠。
---

## DDRM图像重建的小案例

本文以一个简单的复旦大学校徽的图像修补示例，介绍如何使用 **DDRM** 从不完整、含噪的观测数据中重建图像，并同时获得结果的不确定性信息。DDRM 的核心思想并不是学习一个从退化图像到清晰图像的黑箱映射，而是将已知的物理退化模型与神经网络学到的数据先验结合，在概率框架下求解成像逆问题。

### 原始图像与观测数据

实验首先选取一张自然图像作为真实图像（ground truth）。该图像在重建过程中对算法是不可见的，仅用于后续的定量和定性评估。随后，对原始图像施加随机像素遮挡，并叠加高斯噪声，得到观测图像（measurement）。这一过程模拟了成像中常见的信息缺失与噪声干扰问题。

![Measurement](figures/measurement.png)
![Ground truth](figures/ground_truth.png)

### 单次 DDRM 重建结果

在得到观测数据后，首先运行一次 DDRM 扩散反推过程，从后验分布中采样得到一张重建结果。该过程从随机噪声初始化开始，通过多步去噪逐渐恢复图像结构，同时在每一步中强制满足观测一致性约束。作为对照，还计算了简单的线性逆（算子伴随）结果，用于体现扩散模型先验带来的提升。

![DDRM reconstruction](figures/ddrm_reconstruction.png)

该结果可以视为从后验分布中采样得到的一个可能解，其视觉质量和 PSNR 均明显优于线性重建。

### 后验均值与不确定性分析

由于 DDRM 是一个概率模型，同一观测条件下并不存在唯一的确定解。为此，我们进一步采用 Monte Carlo 方式多次运行扩散反推过程，从而估计后验分布的统计量。通过对多次重建结果求平均，得到后验均值，它通常比单次采样结果更加稳定。同时，通过计算逐像素的标准差，可以获得后验不确定性，用于反映模型在不同空间位置的置信程度。

![Posterior mean](figures/posterior_mean.png)
![Posterior standard deviation](figures/posterior_std.png)

可以观察到，不确定性通常集中在被遮挡严重或纹理复杂的区域，而在结构清晰、观测约束较强的位置则明显较低。

### 重建误差分析

在实验中，由于真实图像是已知的，还可以计算后验均值与 ground truth 之间的绝对误差图，用于定量分析重建性能。需要注意的是，该误差图仅用于实验评估，在真实应用场景中通常无法获得。

![Absolute error](figures/absolute_error.png)









